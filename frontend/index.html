<!---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>frontend</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>
-->

<!-- Pregunta 3, inclusion del diagrama-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>frontend</title>
  <style>
    :root{ color-scheme: light; }
    *{ box-sizing: border-box }
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }

    .toolbar{ display:flex; gap:16px; padding:14px 12px; }
    .btn{
      padding:10px 20px; font-size:22px; cursor:pointer;
      background:#f1f1f1; border:1px solid #c9c9c9; border-radius:14px; color:#1f2937;
      transition:border-color .12s, box-shadow .12s, background .12s;
    }
    .btn:hover{ background:#ececec; }
    .btn.active{
      background:#f7f7f7; border-color:#000; box-shadow:0 0 0 2px #000 inset;
    }

    #stage{ display:block; width:100vw; height:68vh; outline:none; }

    .chart-float{
      position: fixed; right: 18px; top: 90px;
      width: 460px; max-width: 46vw; height: 280px;
      background:#fff; border:1px solid #e5e5e5; border-radius:12px;
      box-shadow:0 6px 26px rgba(0,0,0,.12); padding:12px;
    }
    .chart-float h3{ margin:4px 0 8px; font-size:22px }
    .legend{ display:flex; gap:14px; font-size:14px; margin-top:4px }
    .dot{ display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle }
    .red{background:#ef4444}.blue{background:#3b82f6}.green{background:#22c55e}
    @media (max-width: 820px){
      .chart-float{ position:static; width:auto; height:300px; margin:0 12px 12px }
    }
  </style>
</head>
<body>
  <div class="toolbar">
    <button id="btnSetup" class="btn">Setup</button>
    <button id="btnStart" class="btn">Start</button>
    <button id="btnStop"  class="btn">Stop</button>
  </div>

  <canvas id="stage"></canvas>

  <div class="chart-float">
    <h3>Diagrama de trafico</h3>
    <canvas id="chart" style="width:100%;height:200px"></canvas>
    <div class="legend">
      <span><span class="dot red"></span> carro azul</span>
      <span><span class="dot blue"></span> velocidad minima</span>
      <span><span class="dot green"></span> velocidad maxima</span>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const EXTENT_X = 25, EXTENT_Y = 10;
    const LANE_TOL   = 0.25;
    const LOOK_AHEAD = 2.0;
    const DT = 0.4;
    let timer=null, tick=0, agents=[], lanes=[], rng=null;

    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}

    const canvas = document.getElementById('stage');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){ canvas.width=innerWidth; canvas.height=Math.round(innerHeight*0.68); render(); }
    addEventListener('resize', resizeCanvas);

    function clear(){ ctx.clearRect(0,0,canvas.width,canvas.height); }
    function road(){
      const h = Math.round(canvas.height*0.24);
      const y = canvas.height - h - 12;
      ctx.fillStyle = '#a9a9a9';
      ctx.fillRect(12, y, canvas.width-24, h);
      return {Y:y, H:h};
    }

    function drawCarClassic(sx, sy, baseColor){
      ctx.fillStyle = baseColor;
      ctx.fillRect(sx-16, sy-10, 32, 20);

      ctx.fillStyle = '#e45b5b';
      ctx.fillRect(sx-6, sy-6, 12, 12);
      
      ctx.fillStyle = '#7f1d1d';
      ctx.fillRect(sx+16, sy-8, 6, 16);
    
      ctx.fillStyle = '#222';
      ctx.fillRect(sx-20, sy-14, 8, 6);
      ctx.fillRect(sx+12, sy-14, 8, 6);
      ctx.fillRect(sx-20, sy+8, 8, 6);
      ctx.fillRect(sx+12, sy+8, 8, 6);
  
      ctx.fillStyle='#f0b6b6';
      ctx.fillRect(sx-2, sy-2, 4, 4);
    }

    function drawCar(ax, ay, isBlue, roadGeom){
      const sx = 12 + ax*(canvas.width-24)/EXTENT_X;
      const sy = roadGeom.Y + roadGeom.H/2 - (ay-5)*5;
      drawCarClassic(sx, sy, isBlue ? '#2563eb' : '#ef4444'); 
    }

    function render(){
      clear();
      const rg = road();
      for(const a of agents) drawCar(a.x, a.y, a.isBlue, rg);
    }

    function setup(nCars=5, seed=1){
      rng = mulberry32(seed|0);
      tick=0; agents=[]; lanes=[];
      for(let y=1;y<=EXTENT_Y-1;y+=2) lanes.push(y);
      const xs=[...Array(EXTENT_X).keys()].map(i=>i+1);
      for(let i=xs.length-1;i>0;--i){ const j=Math.floor(rng()*(i+1)); [xs[i],xs[j]]=[xs[j],xs[i]]; }

      for(let i=0;i<nCars;i++){
        const px = xs[i], py = lanes[i%lanes.length];
        const isBlue = (i===0);
        const v0 = isBlue? 1.0 : (0.2 + 0.5*rng()); // [0.2,0.7]
        agents.push({ id:i+1, x:px, y:py, v:v0, isBlue });
      }

      chart.data.labels=[0];
      const sh = speedSummary();
      chart.data.datasets[0].data=[sh.blue];
      chart.data.datasets[1].data=[sh.min];
      chart.data.datasets[2].data=[sh.max];
      chart.update();
      render();
    }

    function carAhead(a){
      for(const n of agents){
        if(n.id===a.id) continue;
        if(Math.abs(n.y - a.y) > LANE_TOL) continue;
        let dx = n.x - a.x;
        if(dx<=0) dx += EXTENT_X;
        if(dx>0 && dx<=LOOK_AHEAD) return n;
      }
      return null;
    }

    function step(){
      for(const a of agents){
        const ahead = carAhead(a);
        let nv = ahead ? (a.v - 0.10) : (a.v + 0.05);
        if(nv<0) nv=0; if(nv>1) nv=1;
        a.v = nv;
      }
      for(const a of agents){
        let nx = a.x + a.v*DT;
        while(nx>EXTENT_X) nx -= EXTENT_X;
        a.x = nx;
      }
      tick++;
      const sh = speedSummary();
      chart.data.labels.push(tick);
      chart.data.datasets[0].data.push(sh.blue);
      chart.data.datasets[1].data.push(sh.min);
      chart.data.datasets[2].data.push(sh.max);
      chart.update();
      render();
    }

    function speedSummary(){
      const blue = agents.find(a=>a.isBlue) || agents.reduce((p,c)=>c.v>p.v?c:p, agents[0]);
      const vs = agents.map(a=>a.v);
      return { blue: blue.v, min: Math.min(...vs), max: Math.max(...vs) };
    }

    const chart = new Chart(document.getElementById('chart').getContext('2d'),{
      type:'line',
      data:{ labels:[], datasets:[
        {label:'carro azul', data:[], borderColor:'#ef4444', tension:0, borderWidth:2, pointRadius:0},
        {label:'velocidad minima',            data:[], borderColor:'#3b82f6', tension:0, borderWidth:1.5, pointRadius:0},
        {label:'velocidad maxima',            data:[], borderColor:'#22c55e', tension:0, borderWidth:1.5, pointRadius:0},
      ]},
      options:{ responsive:true, animation:false,
        scales:{ y:{min:0,max:1.1, title:{display:true,text:'velocidad'}}, x:{title:{display:true,text:'tiempo'}} },
        plugins:{ legend:{ position:'bottom' } }
      }
    });

    const bSetup = document.getElementById('btnSetup');
    const bStart = document.getElementById('btnStart');
    const bStop  = document.getElementById('btnStop');
    function setActive(btn){
      for(const b of [bSetup,bStart,bStop]) b.classList.remove('active');
      btn.classList.add('active');
    }

    bSetup.addEventListener('click', ()=>{ if(timer){clearInterval(timer); timer=null;} setActive(bSetup); setup(); });
    bStart.addEventListener('click', ()=>{
      if(!agents.length) setup();
      if(timer) clearInterval(timer);
      setActive(bStart);
      step();                     
      timer = setInterval(step, 150);
    });
    bStop.addEventListener('click', ()=>{ if(timer) clearInterval(timer); timer=null; setActive(bStop); });

  
    resizeCanvas();
    setActive(bSetup);
    setup();
  </script>
</body>
</html>

